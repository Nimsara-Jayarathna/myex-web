name: Deploy Frontend

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  BUILD_DIR: dist

jobs:
  build:
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' &&
       (github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main')) ||
      (github.event_name == 'pull_request' &&
       (github.base_ref == 'dev' || github.base_ref == 'main'))
    # Only pushes to main use the production environment; everything else (including PRs) is staging
    environment: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    outputs:
      deploy_env: ${{ steps.deploy_vars.outputs.deploy_env }}
      target_dir: ${{ steps.deploy_vars.outputs.target_dir }}
      site_name: ${{ steps.deploy_vars.outputs.site_name }}
      branch_name: ${{ steps.deploy_vars.outputs.branch_name }}
      container_name: ${{ steps.deploy_vars.outputs.container_name }}
      port: ${{ steps.deploy_vars.outputs.port }}
      commit_sha: ${{ steps.deploy_vars.outputs.commit_sha }}
      network_name: ${{ steps.deploy_vars.outputs.network_name }}
    env:
      VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set deployment variables
        id: deploy_vars
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "deploy_env=production" >> "$GITHUB_OUTPUT"
            echo "target_dir=/var/www/myex-fe" >> "$GITHUB_OUTPUT"
            echo "site_name=myex-frontend" >> "$GITHUB_OUTPUT"
            echo "branch_name=main" >> "$GITHUB_OUTPUT"
            echo "container_name=myex-frontend" >> "$GITHUB_OUTPUT"
            echo "port=8080" >> "$GITHUB_OUTPUT"
            echo "commit_sha=$COMMIT_SHA" >> "$GITHUB_OUTPUT"
            echo "network_name=npm_default" >> "$GITHUB_OUTPUT"
          else
            echo "deploy_env=staging" >> "$GITHUB_OUTPUT"
            echo "target_dir=/var/www/myex-fe-staging" >> "$GITHUB_OUTPUT"
            echo "site_name=myex-frontend-staging" >> "$GITHUB_OUTPUT"
            echo "branch_name=dev" >> "$GITHUB_OUTPUT"
            echo "container_name=myex-frontend-staging" >> "$GITHUB_OUTPUT"
            echo "port=8080" >> "$GITHUB_OUTPUT"
            echo "commit_sha=$COMMIT_SHA" >> "$GITHUB_OUTPUT"
            echo "network_name=npm_default" >> "$GITHUB_OUTPUT"
          fi

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.BUILD_DIR }}
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main')
    environment: ${{ needs.build.outputs.deploy_env }}
    env:
      TARGET_DIR: ${{ needs.build.outputs.target_dir }}
      SITE_NAME: ${{ needs.build.outputs.site_name }}
      CONTAINER_NAME: ${{ needs.build.outputs.container_name }}
      PORT: ${{ needs.build.outputs.port }}
      COMMIT_SHA: ${{ needs.build.outputs.commit_sha }}
      DOCKER_NETWORK: ${{ needs.build.outputs.network_name }}
      SSH_HOST: ${{ secrets.DO_SSH_HOST }}
      SSH_USER: ${{ secrets.DO_SSH_USER }}
      SSH_PORT: ${{ secrets.DO_SSH_PORT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.BUILD_DIR }}

      - name: Prepare SSH key
        env:
          SSH_KEY: ${{ secrets.DO_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add droplet to known hosts
        run: |
          ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Stop and remove existing container
        run: |
          ssh -i ~/.ssh/id_rsa -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
            "docker rm -f $CONTAINER_NAME || true"

      - name: Pull latest Nginx image
        run: |
          ssh -i ~/.ssh/id_rsa -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
            "docker pull nginx:latest"

      - name: Ensure Docker network exists
        run: |
          ssh -i ~/.ssh/id_rsa -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
            "docker network inspect $DOCKER_NETWORK >/dev/null 2>&1 || docker network create $DOCKER_NETWORK"

      - name: Create target directory on server
        run: |
          ssh -i ~/.ssh/id_rsa -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
            "mkdir -p '$TARGET_DIR'"

      - name: Sync build to server
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa -p ${SSH_PORT}" \
            "${BUILD_DIR}/" "${SSH_USER}@${SSH_HOST}:${TARGET_DIR}/"

      - name: Upload nginx config
        run: |
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -p ${SSH_PORT}" \
            "nginx.conf" "${SSH_USER}@${SSH_HOST}:${TARGET_DIR}/../nginx.conf"

      - name: Run frontend container
        run: |
          ssh -i ~/.ssh/id_rsa -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" <<EOF
          docker run -d --name $CONTAINER_NAME \
            --network $DOCKER_NETWORK \
            --network-alias $CONTAINER_NAME \
            -p $PORT:80 \
            -v $TARGET_DIR:/usr/share/nginx/html:ro \
            -v ${TARGET_DIR}/../nginx.conf:/etc/nginx/conf.d/default.conf:ro \
            --restart unless-stopped \
            --label commit_sha=$COMMIT_SHA \
            nginx:latest
          EOF
